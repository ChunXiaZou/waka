!function(e){"use strict";function t(e){e.theme("default").primaryPalette("indigo").accentPalette("pink")}e.module("waka",["ui.router","ngResource","ngMaterial","ngFileUpload","ngImgCrop"]),e.module("waka").config(["$mdThemingProvider",t])}(angular),function(e){"use strict";function t(e,t){e.state("user-login",{url:"/user-login",templateUrl:"app/routes/user-login/user-login.html",controller:"loginController",controllerAs:"account"}).state("home-page",{url:"/home-page",templateUrl:"app/routes/home-page/home-page.html",controller:"homeController",controllerAs:"home"}).state("user-setting",{url:"/user-setting",templateUrl:"app/routes/user-setting/user-setting.html",controller:"userSettingController",controllerAs:"vm"}).state("user-page",{url:"/user-page",templateUrl:"app/routes/user-page/user-page.html",controller:"userPageController",controllerAs:"vm"}).state("user-page.answer",{url:"/answer",views:{"user-page":{templateUrl:"app/routes/user-page-answer/user-page-answer.html",controller:"userAnswerController",controllerAs:"vm"}}}).state("user-page.collection",{url:"/collection",views:{"user-page":{templateUrl:"app/routes/user-page-collection/user-page-collection.html",controller:"userCollectionController",controllerAs:"vm"}}}).state("user-page.question",{url:"/question",views:{"user-page":{templateUrl:"app/routes/user-page-question/user-page-question.html",controller:"userQuestionController",controllerAs:"vm"}}}).state("user-page.topic",{url:"/topic",views:{"user-page":{templateUrl:"app/routes/user-page-topic/user-page-topic.html",controller:"userTopicController",controllerAs:"vm"}}}).state("find-question",{url:"/find-question",templateUrl:"app/routes/find-question-page/find-question-page.html",controller:"findQuestionController",controllerAs:"vm"}).state("question",{url:"/question/:question_id",templateUrl:"app/routes/question/question.html",controller:"questionController",controllerAs:"vm"}).state("question-editor",{url:"/question-editor",templateUrl:"app/routes/question-editor/question-editor.html",controller:"questionEditorController",controllerAs:"vm"}).state("answer-editor",{url:"/answer-editor/:question_id",templateUrl:"app/routes/answer-editor/answer-editor.html",controller:"answerEditorController",controllerAs:"vm"}),t.otherwise("/user-login")}e.module("waka").config(["$stateProvider","$urlRouterProvider",t])}(angular),function(e){"use strict";var t="api";e.module("waka").factory("URL",[function(){return t+"/"}]).factory("User",["$resource",function(e){var o=t+"/user/";return e(t+"/user/:id",{id:"@id"},{login:{method:"POST",url:o+"login"},logout:{method:"GET",url:o+"logout"},getCurrentUser:{method:"GET",url:o+"currentUser"},update:{method:"POST",url:o+"update"},updatePassword:{method:"POST",url:o+"password"}})}]).factory("Question",["$resource",function(e){var o=t+"/question/";return e(t+"/question/:question_id",{question_id:"@question_id"},{add:{method:"POST",url:o+"add"},search:{method:"POST",url:o+"search"},update:{method:"POST",url:o+"update"},getNoAnswer:{method:"POST",url:o+"getNoAnswer"},getNew:{method:"POST",url:o+"getNew"},getHot:{method:"POST",url:o+"getHot"},getByUser:{method:"GET",url:o+"getByUser/:author_id",params:{author_id:"@author_id"}},attitude:{method:"POST",url:o+"attitude"},follow:{method:"POST",url:o+"follow"},getFollower:{method:"GET",url:o+"getFollower/:question_id",params:{question_id:"@question_id"}},getFollwerList:{method:"GET",url:o+"getFollwerList/:follower_id",params:{follower_id:"@follower_id"}}})}]).factory("Answer",["$resource",function(e){var o=t+"/answer/";return e(t+"/answer",{},{getByTopic:{method:"POST",url:o+"getByTopic"},getByUserTopics:{method:"POST",url:o+"getByUserTopics"},getByQuestion:{method:"GET",url:o+"getByQuestion/:question_id",params:{question_id:"@question_id"}},getByUser:{method:"GET",url:o+"getByUser/:author_id",params:{author_id:"@author_id"}},getByUserAndQuestion:{method:"POST",url:o+"getByUserAndQuestion"},collection:{method:"GET",url:o+"collection/:user_id",params:{user_id:"@user_id"}},addCollection:{method:"POST",url:o+"addCollection"},attitude:{method:"POST",url:o+"attitude"},add:{method:"POST",url:o+"add"},update:{method:"POST",url:o+"update"},del:{method:"POST",url:o+"del"}})}]).factory("Topic",["$resource",function(e){var o=t+"/topic/";return e(t+"/topic",{},{add:{method:"POST",url:o+"add"},sub:{method:"GET",url:o+"sub/:name",params:{name:"@name"}},update:{method:"POST",url:o+"update"},list:{method:"GET",url:o+"list"}})}]).factory("Reply",["$resource",function(e){var o=t+"/reply/";return e(t+"/reply",{},{add:{method:"POST",url:o+"add"},update:{method:"POST",url:o+"update"},del:{method:"POST",url:o+"del"},list:{method:"GET",url:o+"list/:answer_id",params:{answer_id:"@answer_id"}}})}]).factory("Message",["$resource",function(e){var o=t+"/message/";return e(t+"/message",{},{getMes:{method:"POST",url:o+"getMes"}})}])}(angular),function(e){"use strict";e.module("waka").factory("iAES",function(){return{encrypt:function(e){return CryptoJS.AES.encrypt(e,"iwaka")},decrypt:function(e){return CryptoJS.AES.decrypt(e,"iwaka").toString(CryptoJS.enc.Utf8)}}}).factory("iCookie",function(){return{setUserCookie:function(e,t,o){document.cookie="uid="+e+";max-age=864000",document.cookie="username="+t+";max-age=864000",document.cookie="password="+o+";max-age=864000"},setCookie:function(e,t,o){document.cookie=e+"="+t+";max-age="+o},getCookie:function(e){var t=document.cookie;if(t){t=t.substr(t.indexOf(e));var o=t.indexOf(";")>-1?t.indexOf(";"):t.length,n=t.substring(t.indexOf("=")+1,o);return n}return null},cancelCookie:function(){var e=document.cookie.split(";");e.forEach(function(e){document.cookie=e+";max-age=0"})},updatePasswordCookie:function(e){e=e,document.cookie="password="+e+";max-age=864000"}}})}(angular),function(e){"use strict";e.module("waka").factory("timeFormat",function(){return{postedTime:function(e){var t=new Date(e),o=new Date,n=(o-t)/6e4;return 60>=n?Math.floor(n)+"分钟前":n>60&&1440>=n?Math.floor(n/60)+"小时前":n>1440&&28800>=n?Math.floor(n/1440)+"天前":t.getYear()+"-"+t.getMonth()+"-"+t.getDate()}}})}(angular),function(e){"use strict";function t(e,t,o,n,r){function i(){l();var e={question_id:d,author_id:m,content:c.content,contentHtml:c.contentHtml};console.log(e),n.add(JSON.stringify(e)).$promise.then(function(e){e.status>-1?alert("添加回答成功"):alert("添加回答失败")})}function s(){l();var e={_id:p,content:c.content,contentHtml:c.contentHtml};console.log(e),n.update(JSON.stringify(e)).$promise.then(function(e){e.status>-1?alert("更新回答成功"):alert("更新回答失败")})}function a(){var e={question_id:d,author_id:m};console.log(e),n.getByUserAndQuestion(JSON.stringify(e)).$promise.then(function(e){if(e.data[0]){var t=e.data[0];c.hasAnswer=!0,c.content=t.answer.content,c.title=t.question.title,p=t.answer._id}else u(d)})}function u(e){o.getQuestion({id:e}).$promise.then(function(e){c.title=e.data.title})}function l(){c.simplemde?(c.content=c.simplemde.value(),c.contentHtml=c.simplemde.markdown(c.simplemde.value())):alert("getContent error")}var c=this,d=location.hash.split("/")[2],m=r.getCookie("uid"),p="";c.simplemde="",c.content="",c.contentHtml="",c.title="",c.hasAnswer=!1,c.addAnswer=i,c.updateAnswer=s,a()}e.module("waka").controller("answerEditorController",["$scope","$state","Question","Answer","iCookie",t])}(angular),function(e){"use strict";function t(e,t,o){}e.module("waka").controller("findQuestionController",["$scope","$state","Question",t])}(angular),function(e){"use strict";function t(e,t,o,n,r){function i(){var e=location.hash.split("/");console.log(e),o.get({question_id:e[2]}).$promise.then(function(e){if(e.status>-1){console.log(e);var t=e.data[0];a.question=t.question,a.question.author=t.author,a.question.createdTime=n.postedTime(a.question.created_time),s(a.question._id)}else alert("getQuestion error")})}function s(e){r.getByQuestion({question_id:e}).$promise.then(function(e){e.status>-1?a.answerList=e.data:alert("getAnswers error")})}var a=this;a.answerList=[],a.question="",i(),a.postedTime=n.postedTime}e.module("waka").controller("questionController",["$scope","$state","Question","timeFormat","Answer",t])}(angular),function(e){"use strict";function t(e,t,o,n,r){function i(){c.simplemde?(c.content=c.simplemde.value(),c.contentHtml=c.simplemde.markdown(c.simplemde.value())):alert("getContent error")}function s(){if(!c.title||!c.topics)return void alert("标题跟话题分类不能为空");var e=c.topics.map(function(e){return e._id});i();var n={title:c.title,topics:e,content:c.content,contentHtml:c.contentHtml,author_id:r.getCookie("uid")};console.log(n),o.add(JSON.stringify(n)).$promise.then(function(e){-1===e.status?alert("添加问题失败"):(console.log("添加问题成功"),t.go("question",{question_id:e.data._id}))})}function a(e){var t=e?c.allTopics.filter(u(e)):[];return t}function u(e){return function(t){return-1!==t.indexOf(e)}}function l(){n.list().$promise.then(function(e){c.allTopics=e.data})}var c=this;c.querySearch=a,c.allTopics=[],c.topics=[],c.filterSelected=!0,c.content="",c.contentHtml="",c.title="",c.simplemde="",c.submit=s,l()}e.module("waka").controller("questionEditorController",["$scope","$state","Question","Topic","iCookie",t])}(angular),function(e){"use strict";function t(e,t,o,n){function r(e){n.login(e).$promise.then(function(n){if(console.log(n),-1===n.status)switch(n.error){case"user":case"password":return c.auth.loginErr=!0,void t(i,4e3)}n.status>-1&&(a("uid")||(console.log("set cookie"),s(n.data._id,n.data.username,e.password)),t(function(){o.go("home-page")},1e3))})}function i(){c.auth={email:!1,pass:!1,userExist:!1,loginErr:!1,emailExist:!1}}function s(e,t,o){t=u(t),o=u(o),document.cookie="uid="+e+";max-age=864000",document.cookie="username="+t+";max-age=864000",document.cookie="password="+o+";max-age=864000"}function a(e){var t=document.cookie;if(t){t=t.substr(t.indexOf(e));var o=t.indexOf(";")>-1?t.indexOf(";"):t.length,n=t.substring(t.indexOf("=")+1,o);return n}return null}function u(e){return CryptoJS.AES.encrypt(e,"iwaka")}function l(e){return CryptoJS.AES.decrypt(e,"iwaka").toString(CryptoJS.enc.Utf8)}var c=this,d=/^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;c.signin=!0,c.auth={email:!1,pass:!1,loginErr:!1,userExist:!1,emailExist:!1},function(){if(a("uid")){var e={username:l(a("username")),password:l(a("password"))};r(e)}}(),c.login=function(){var e={email:d.test(c.email)?c.email:"",username:d.test(c.email)?"":c.email,password:c.password};r(e)},c.signup=function(){var e=c.reg;if(e.password!==e.password2)return c.auth.pass=!0,void t(i,4e3);if(!d.test(e.email))return c.auth.email=!0,void t(i,4e3);var r={username:e.username,email:e.email,password:e.password};n.save(r).$promise.then(function(e){if(console.log(e),-1===e.status)switch(e.error){case"email":return c.auth.emailExist=!0,void t(i,4e3);case"username":return c.auth.userExist=!0,void t(i,4e3)}e.status>-1&&(console.log("signup success"),o.go("home-page"))},function(e){console.log("signup fail"),console.log(e)})}}e.module("waka").controller("loginController",["$scope","$timeout","$state","User",t])}(angular),function(e){"use strict";function t(e,t,o){var n=this;n.itemList=[{title:"我的提问",url:"question"},{title:"我的回答",url:"answer"},{title:"我的收藏",url:"collection"},{title:"关注话题",url:"topic"}],n.userSetting=function(){t.go("user-setting")}}e.module("waka").controller("userPageController",["$scope","$state","User",t])}(angular),function(e){"use strict";function t(e,t,o){}e.module("waka").controller("userAnswerController",["$scope","$state","User",t])}(angular),function(e){"use strict";function t(e,t,o){}e.module("waka").controller("homeController",["$scope","$state","User",t])}(angular),function(e){"use strict";function t(e,t,o){}e.module("waka").controller("userCollectionController",["$scope","$state","User",t])}(angular),function(e){"use strict";function t(e,t,o){}e.module("waka").controller("userQuestionController",["$scope","$state","User",t])}(angular),function(e){"use strict";function t(e,t,o){}e.module("waka").controller("userTopicController",["$scope","$state","User",t])}(angular),function(e){"use strict";function t(e,t,o,n,r){function i(){n.getCurrentUser().$promise.then(function(e){var t=e.data;u.username=t.username,u.bio=t.bio,u.description=t.description})}function s(e){e=a(e),document.cookie="password="+e+";max-age=864000"}function a(e){return CryptoJS.AES.encrypt(e,"iwaka")}var u=this;u.picFile="",u.username="",u.bio="",u.description="",u.oldPassword="",u.newPassword="",u.newPassword2="",u.savingAvatar=!1,u.savingInfo=!1,u.savingPassword=!1,i(),u.updateInfo=function(){var e={username:u.username,bio:u.bio,description:u.description};n.update(e).$promise.then(function(e){u.savingInfo=!0,e.status>-1&&o(function(){u.savingInfo=!1,u.savingInfoMes="保存成功"},2e3)})},u.updatePassword=function(){u.newPassword!==u.newPassword2&&(u.savingPasswordMes="密码不一致");var e={oldPassword:u.oldPassword,newPassword:u.newPassword};n.updatePassword(e).$promise.then(function(e){u.savingPassword=!0,console.log(e),e.data.error?(u.savingPassword=!1,u.savingPasswordMes="旧密码不正确"):o(function(){u.savingPassword=!1,u.savingPasswordMes="保存成功",s(u.newPassword)},2e3)})},u.upload=function(e){u.savingAvatar=!0,r.upload({url:"/api/user/imgUpload",file:r.dataUrltoBlob(e)}).then(function(e){e.status>-1&&o(function(){window.location.reload()},2500)})}}e.module("waka").controller("userSettingController",["$scope","$state","$timeout","User","Upload",t])}(angular),function(e){function t(){function e(e,t,o,n){function r(){s.value(i.content)}var i=this,s=new SimpleMDE({element:document.getElementById("editor")});r(),i.simplemde=s,i.submit=function(){},i.show=function(){console.log(s.markdown(s.value())),alert(s.value())}}var t={restrict:"E",templateUrl:"app/components/editor/editor.html",scope:{content:"=",drContentHtml:"=",simplemde:"="},controller:e,controllerAs:"editor",bindToController:!0};return t}e.module("waka").directive("myEditor",t)}(angular),function(e){"use strict";function t(){function e(e,t,o,n){function r(){location.href="/#/user-page"}function i(){location.href="/#/user-setting"}function s(){u(),n.logout(),t.go("user-login")}function a(){n.get({id:l("uid")}).$promise.then(function(e){c.avatar="../assets/images/user/"+e.data.avatar})}function u(){var e=document.cookie.split(";");e.forEach(function(e){document.cookie=e+";max-age=0"})}function l(e){var t=document.cookie;if(t){t=t.substr(t.indexOf(e));var o=t.indexOf(";")>-1?t.indexOf(";"):t.length,n=t.substring(t.indexOf("=")+1,o);return n}return null}var c=this,d="../assets/images/icons/";c.isOpen=!1,c.tooltipVisible=!1,c.avatar="../assets/images/user/default.png",a(),e.$watch("vm.isOpen",function(e){e?o(function(){c.tooltipVisible=c.isOpen},600):c.tooltipVisible=c.isOpen}),c.items=[{name:"我的主页",icon:d+"people.svg",direction:"left",action:"toHomePage"},{name:"修改信息",icon:d+"setting.svg",direction:"left",action:"toUpdateInfo"},{name:"退出",icon:d+"logout.svg",direction:"left",action:"logout"}],c.action=function(e){switch(e){case"toHomePage":r();break;case"toUpdateInfo":i();break;case"logout":s()}}}var t={restrict:"E",templateUrl:"app/components/navbar/navbar.html",scope:{creationDate:"="},controller:e,controllerAs:"vm",bindToController:!0};return t}e.module("waka").directive("navBar",t)}(angular);