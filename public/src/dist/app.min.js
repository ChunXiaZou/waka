!function(t){"use strict";function e(t){t.theme("default").primaryPalette("indigo").accentPalette("pink")}t.module("waka",["ui.router","ngResource","ngSanitize","ngMaterial","ngFileUpload","ngImgCrop"]),t.module("waka").config(["$mdThemingProvider",e])}(angular),function(t){"use strict";function e(t,e){t.state("user-login",{url:"/user-login",templateUrl:"app/routes/user-login/user-login.html",controller:"loginController",controllerAs:"account"}).state("home-page",{url:"/home-page",templateUrl:"app/routes/home-page/home-page.html",controller:"homeController",controllerAs:"home"}).state("user-setting",{url:"/user-setting",templateUrl:"app/routes/user-setting/user-setting.html",controller:"userSettingController",controllerAs:"vm"}).state("user-page",{url:"/user-page",templateUrl:"app/routes/user-page/user-page.html",controller:"userPageController",controllerAs:"vm"}).state("user-page.answer",{url:"/answer",views:{"user-page":{templateUrl:"app/routes/user-page-answer/user-page-answer.html",controller:"userAnswerController",controllerAs:"vm"}}}).state("user-page.collection",{url:"/collection",views:{"user-page":{templateUrl:"app/routes/user-page-collection/user-page-collection.html",controller:"userCollectionController",controllerAs:"vm"}}}).state("user-page.question",{url:"/question",views:{"user-page":{templateUrl:"app/routes/user-page-question/user-page-question.html",controller:"userQuestionController",controllerAs:"vm"}}}).state("user-page.topic",{url:"/topic",views:{"user-page":{templateUrl:"app/routes/user-page-topic/user-page-topic.html",controller:"userTopicController",controllerAs:"vm"}}}).state("find-question",{url:"/find-question",templateUrl:"app/routes/find-question-page/find-question-page.html",controller:"findQuestionController",controllerAs:"vm"}).state("question",{url:"/question/:question_id",templateUrl:"app/routes/question/question.html",controller:"questionController",controllerAs:"vm"}).state("question-editor",{url:"/question-editor",templateUrl:"app/routes/question-editor/question-editor.html",controller:"questionEditorController",controllerAs:"vm"}).state("answer-editor",{url:"/answer-editor/:question_id",templateUrl:"app/routes/answer-editor/answer-editor.html",controller:"answerEditorController",controllerAs:"vm"}).state("topic",{url:"/topic",templateUrl:"app/routes/topic/topic.html",controller:"topicController",controllerAs:"vm"}).state("topic.tree",{url:"/:topic_id",templateUrl:"app/routes/topic-tree/topic-tree.html",controller:"topicTreeController",controllerAs:"tree"}),e.otherwise("/user-login")}t.module("waka").config(["$stateProvider","$urlRouterProvider",e])}(angular),function(t){"use strict";var e="api";t.module("waka").factory("URL",[function(){return e+"/"}]).factory("User",["$resource",function(t){var o=e+"/user/";return t(e+"/user/:id",{id:"@id"},{login:{method:"POST",url:o+"login"},logout:{method:"GET",url:o+"logout"},getCurrentUser:{method:"GET",url:o+"currentUser"},update:{method:"POST",url:o+"update"},updatePassword:{method:"POST",url:o+"password"},getFollowingTopic:{method:"GET",url:o+"followingTopic/:_id",params:{_id:"@_id"}}})}]).factory("Question",["$resource",function(t){var o=e+"/question/";return t(e+"/question/:question_id",{question_id:"@question_id"},{add:{method:"POST",url:o+"add"},search:{method:"POST",url:o+"search"},update:{method:"POST",url:o+"update"},getNoAnswer:{method:"POST",url:o+"getNoAnswer"},getNew:{method:"POST",url:o+"getNew"},getHot:{method:"POST",url:o+"getHot"},getByUser:{method:"GET",url:o+"getByUser/:author_id",params:{author_id:"@author_id"}},attitude:{method:"POST",url:o+"attitude"},follow:{method:"POST",url:o+"follow"},getFollower:{method:"GET",url:o+"getFollower/:question_id",params:{question_id:"@question_id"}},getFollowerList:{method:"GET",url:o+"getFollwerList/:follower_id",params:{follower_id:"@follower_id"}}})}]).factory("Answer",["$resource",function(t){var o=e+"/answer/";return t(e+"/answer",{},{getByTopic:{method:"POST",url:o+"getByTopic"},getByUserTopics:{method:"POST",url:o+"getByUserTopics"},getByQuestion:{method:"GET",url:o+"getByQuestion/:question_id",params:{question_id:"@question_id"}},getByUser:{method:"GET",url:o+"getByUser/:author_id",params:{author_id:"@author_id"}},getByUserAndQuestion:{method:"POST",url:o+"getByUserAndQuestion"},collection:{method:"GET",url:o+"collection/:user_id",params:{user_id:"@user_id"}},addCollection:{method:"POST",url:o+"addCollection"},attitude:{method:"POST",url:o+"attitude"},add:{method:"POST",url:o+"add"},update:{method:"POST",url:o+"update"},del:{method:"POST",url:o+"del"}})}]).factory("Topic",["$resource",function(t){var o=e+"/topic/";return t(e+"/topic/:_id",{_id:"@_id"},{add:{method:"POST",url:o+"add"},sub:{method:"GET",url:o+"sub/:_id",params:{_id:"@_id"}},getAllChild:{method:"GET",url:o+"allChild/:_id",params:{_id:"@_id"}},update:{method:"POST",url:o+"update"},list:{method:"GET",url:o+"list"},getTopicsId:{method:"POST",url:o+"getTopicsId"},getTopicByIdList:{method:"POST",url:o+"getTopicByIdList"}})}]).factory("Reply",["$resource",function(t){var o=e+"/reply/";return t(e+"/reply",{},{add:{method:"POST",url:o+"add"},update:{method:"POST",url:o+"update"},del:{method:"POST",url:o+"del"},list:{method:"GET",url:o+"list/:answer_id",params:{answer_id:"@answer_id"}}})}]).factory("Message",["$resource",function(t){var o=e+"/message/";return t(e+"/message",{},{getMes:{method:"POST",url:o+"getMes"}})}]).factory("Attitude",["$resource",function(t){var o=e+"/attitude/";return t(e+"/attitude",{},{getAttitude:{method:"POST",url:o+"getAttitude"},setAttitude:{method:"POST",url:o+"setAttitude"}})}])}(angular),function(t){"use strict";t.module("waka").factory("iAES",function(){return{encrypt:function(t){return CryptoJS.AES.encrypt(t,"iwaka")},decrypt:function(t){return CryptoJS.AES.decrypt(t,"iwaka").toString(CryptoJS.enc.Utf8)}}}).factory("iCookie",function(){return{setUserCookie:function(t,e,o){document.cookie="uid="+t+";max-age=864000",document.cookie="username="+e+";max-age=864000",document.cookie="password="+o+";max-age=864000"},setCookie:function(t,e,o){document.cookie=t+"="+e+";max-age="+o},getCookie:function(t){var e=document.cookie;if(e){e=e.substr(e.indexOf(t));var o=e.indexOf(";")>-1?e.indexOf(";"):e.length,n=e.substring(e.indexOf("=")+1,o);return n}return null},cancelCookie:function(){var t=document.cookie.split(";");t.forEach(function(t){document.cookie=t+";max-age=0"})},updatePasswordCookie:function(t){t=t,document.cookie="password="+t+";max-age=864000"}}})}(angular),function(t){"use strict";t.module("waka").factory("timeFormat",function(){return{postedTime:function(t){var e=new Date(t),o=new Date,n=(o-e)/6e4;return 60>=n?Math.floor(n)+"分钟前":n>60&&1440>=n?Math.floor(n/60)+"小时前":n>1440&&28800>=n?Math.floor(n/1440)+"天前":e.getYear()+"-"+e.getMonth()+"-"+e.getDate()}}})}(angular),function(t){"use strict";function e(){function t(t,e,o,n){function i(){r()}function r(){var t=location.href.split("#/topic/")[1];n.get({_id:t}).$promise.then(function(t){s.parentTopic=t.data})}var s=this;s.parentTopic="",s.topicToAdd="",s.cancel=function(){o.cancel()},s.addTopic=function(){if(!s.topicToAdd)return void alert("话题名不能为空");var t={name:s.topicToAdd,parent:s.parentTopic.name};o.hide(),n.add(t).$promise.then(function(t){t.status>-1&&(alert("添加成功"),s.initTree())})},i()}var e={restrict:"E",templateUrl:"app/components/dialog/dialog.html",scope:{initTree:"&"},controller:t,controllerAs:"vm",bindToController:!0};return e}t.module("waka").directive("topicDialog",e)}(angular),function(t){function e(){function t(t,e,o,n,i){function r(){a.value(s.content)}var s=this,a=new SimpleMDE({element:document.getElementById("editor"),spellChecker:!1});t.$watch("vm.content",function(){o(function(){r()},2e3)}),s.simplemde=a,s.submit=function(){},s.show=function(){console.log(a.markdown(a.value())),alert(a.value())}}var e={restrict:"E",templateUrl:"app/components/editor/editor.html",scope:{content:"=",drContentHtml:"=",simplemde:"="},controller:t,controllerAs:"editor",bindToController:!0};return e}t.module("waka").directive("myEditor",e)}(angular),function(t){"use strict";function e(){function t(t,e,o,n){function i(){location.href="/#/user-page"}function r(){location.href="/#/user-setting"}function s(){u(),n.logout(),e.go("user-login")}function a(){n.get({id:l("uid")}).$promise.then(function(t){c.avatar="../assets/images/user/"+t.data.avatar})}function u(){var t=document.cookie.split(";");t.forEach(function(t){document.cookie=t+";max-age=0"})}function l(t){var e=document.cookie;if(e){e=e.substr(e.indexOf(t));var o=e.indexOf(";")>-1?e.indexOf(";"):e.length,n=e.substring(e.indexOf("=")+1,o);return n}return null}var c=this,d="../assets/images/icons/";c.isOpen=!1,c.tooltipVisible=!1,c.avatar="../assets/images/user/default.png",a(),t.$watch("vm.isOpen",function(t){t?o(function(){c.tooltipVisible=c.isOpen},600):c.tooltipVisible=c.isOpen}),c.items=[{name:"我的主页",icon:d+"people.svg",direction:"left",action:"toHomePage"},{name:"修改信息",icon:d+"setting.svg",direction:"left",action:"toUpdateInfo"},{name:"退出",icon:d+"logout.svg",direction:"left",action:"logout"}],c.addQuestion=function(){e.go("question-editor")},c.action=function(t){switch(t){case"toHomePage":i();break;case"toUpdateInfo":r();break;case"logout":s()}}}var e={restrict:"E",templateUrl:"app/components/navbar/navbar.html",scope:{creationDate:"="},controller:t,controllerAs:"vm",bindToController:!0};return e}t.module("waka").directive("navBar",e)}(angular),function(t){"use strict";function e(t,e,o,n,i){function r(){l();var t={question_id:d,author_id:p,content:c.content,contentHtml:c.contentHtml};console.log(t),n.add(JSON.stringify(t)).$promise.then(function(t){t.status>-1?(alert("添加回答成功"),location.href="/#/question/"+d):alert("添加回答失败")})}function s(){l();var t={_id:m,author_id:p,content:c.content,contentHtml:c.contentHtml};console.log(t),n.update(JSON.stringify(t)).$promise.then(function(t){console.log(t),t.status>-1?alert("更新回答成功"):alert("更新回答失败")})}function a(){var t={question_id:d,author_id:p};console.log(t),n.getByUserAndQuestion(JSON.stringify(t)).$promise.then(function(t){if(t.data[0]){var e=t.data[0];c.hasAnswer=!0,c.content=e.answer.content,c.title=e.question.title,m=e.answer._id}else u(d)})}function u(t){o.get({question_id:t}).$promise.then(function(t){var e=t.data[0];c.title=e.question.title})}function l(){c.simplemde?(c.content=c.simplemde.value(),c.contentHtml=c.simplemde.markdown(c.simplemde.value())):alert("getContent error")}var c=this,d=location.hash.split("/")[2],p=i.getCookie("uid"),m="";c.simplemde="",c.content="",c.contentHtml="",c.title="",c.hasAnswer=!1,c.addAnswer=r,c.updateAnswer=s,a()}t.module("waka").controller("answerEditorController",["$scope","$state","Question","Answer","iCookie",e])}(angular),function(t){"use strict";function e(t,e,o,n,i,r,s,a){function u(){l(),o(function(){c(),d()},500)}function l(){p(function(t){var e={topics:t};n.getNew(JSON.stringify(e)).$promise.then(function(t){console.log("getNew"),console.log(t),f.questionNew=t.data})})}function c(){p(function(t){var e={topics:t};n.getHot(JSON.stringify(e)).$promise.then(function(t){console.log("getHot"),console.log(t),f.questionHot=t.data})})}function d(){p(function(t){var e={topics:t};n.getNoAnswer(JSON.stringify(e)).$promise.then(function(t){console.log("getNoAnswer"),console.log(t),f.questionNoAnswer=t.data})})}function p(t){return f.followingTopicIdList?void t(f.followingTopicIdList):void r.getFollowingTopic({_id:s.getCookie("uid")}).$promise.then(function(e){e.data.user;if(console.log("getFollowingTopic"),console.log(e),e.data.topics.length>0){var o=e.data.topics.map(function(t){return t._id});f.followingTopicIdList=o,t(o)}else m(function(e){var o=e.map(function(t){return t._id});t(o)})})}function m(t){f.allTopics?t(f.allTopics):i.list().$promise.then(function(e){f.allTopics=e.data,t(e.data)})}var f=this;f.postedTime=a.postedTime,f.allTopics="",f.followingTopic="",f.questionNew="",f.questionHot="",f.questionNoAnswer="",u()}t.module("waka").controller("findQuestionController",["$scope","$state","$timeout","Question","Topic","User","iCookie","timeFormat",e])}(angular),function(t){"use strict";function e(t,e,o,n,i,r){function s(){a(function(t){var e={topicList:t};n.getByUserTopics(JSON.stringify(e)).$promise.then(function(t){console.log(t),l.answerList=t.data,l.answerListRight=l.answerList.slice(0,l.answerList.length/2),l.answerListLeft=l.answerList.slice(l.answerList.length/2)})})}function a(t){return l.followingTopicIdList?void t(l.followingTopicIdList):void o.getFollowingTopic({_id:r.getCookie("uid")}).$promise.then(function(e){e.data.user;if(e.data.topics.length>0){var o=e.data.topics.map(function(t){return t._id});l.followingTopicIdList=o,t(o)}else u(function(e){var o=e.map(function(t){return t._id});t(o)})})}function u(t){l.allTopics?t(l.allTopics):i.list().$promise.then(function(e){l.allTopics=e.data,t(e.data)})}var l=this;l.allTopics="",l.followingTopic="",l.answerList="",l.answerListLeft="",l.answerListRight="",s()}t.module("waka").controller("homeController",["$scope","$state","User","Answer","Topic","iCookie",e])}(angular),function(t){"use strict";function e(t,e,o,n,i,r,s,a){function u(){console.log(g),n.get({question_id:g}).$promise.then(function(t){if(t.status>-1){console.log(t);var e=t.data[0];f.question=e.question,f.question.author=e.author,f.question.topics=e.topics,f.question.createdTime=i.postedTime(f.question.created_time),c(f.question._id),l(f.question._id)}else alert("getQuestion error")})}function l(t){r.getByQuestion({question_id:t}).$promise.then(function(t){t.status>-1?(f.answerList=t.data,d()):alert("getAnswers error")})}function c(t){var e={user_id:h,question_id:t};s.getAttitude(JSON.stringify(e)).$promise.then(function(t){t.status>0&&(f.question.attitude=t.data)})}function d(){f.answerList.forEach(function(t,e){var o={user_id:h,answer_id:t.answer._id};s.getAttitude(JSON.stringify(o)).$promise.then(function(t){t.status>0&&(f.answerList[e].attitude=t.data)})})}function p(){location.href="/#/answer-editor/"+g}function m(t){return a.getCookie("uid")==t}var f=this,g=location.hash.split("/")[2],h=a.getCookie("uid");f.answerList=[],f.question="",f.addAnswer=p,f.checkAuthor=m,u(),f.postedTime=i.postedTime}t.module("waka").controller("questionController",["$scope","$state","$sce","Question","timeFormat","Answer","Attitude","iCookie",e])}(angular),function(t){"use strict";function e(t,e,o,n,i){function r(){c.simplemde?(c.content=c.simplemde.value(),c.contentHtml=c.simplemde.markdown(c.simplemde.value())):alert("getContent error")}function s(){if(!c.title||!c.topics)return void alert("标题跟话题分类不能为空");var t=c.topics.map(function(t){return t._id});r();var e={title:c.title,topics:t,content:c.content,contentHtml:c.contentHtml,author_id:i.getCookie("uid")};console.log(e),o.add(JSON.stringify(e)).$promise.then(function(t){-1===t.status?alert("添加问题失败"):(console.log("添加问题成功"),location.href="/#/question/"+t.data._id)})}function a(t){var e=t?c.allTopics.filter(u(t)):[];return e}function u(t){return function(e){return-1!==e.name.indexOf(t)}}function l(){n.list().$promise.then(function(t){c.allTopics=t.data,c.querySearch=a})}var c=this;c.querySearch="",c.allTopics=[],c.topics=[],c.filterSelected=!0,c.content="",c.contentHtml="",c.title="",c.simplemde="",c.submit=s,l()}t.module("waka").controller("questionEditorController",["$scope","$state","Question","Topic","iCookie",e])}(angular),function(t){"use strict";function e(t,e,o,n,i){function r(){u(),l()}function s(t){var e=t?p.allTopics.filter(a(t)):[];return e}function a(t){return function(e){return-1!==e.name.indexOf(t)}}function u(){o.list().$promise.then(function(t){p.allTopics=t.data,p.querySearch=s,location.href="/#topic/56d6f9a7eb0e07a804e952c9"})}function l(){var t=i.getCookie("uid");n.getFollowingTopic({_id:t}).$promise.then(function(t){console.log(t),p.topics=t.data.topics})}function c(){var t=d(),e=!0;if(0===t.length&&(e=confirm("你确认要取消所有关注么？")),e){var o={_id:i.getCookie("uid"),following_topic:t};n.update(JSON.stringify(o)).$promise.then(function(t){t.status>-1?(console.log(t),alert("关注的话题已更新")):(alert("程序出错"),console.log(t))})}}function d(){var t=p.topics.map(function(t){return t._id});return t}var p=this;p.querySearch="",p.allTopics=[],p.topics=[],p.filterSelected=!0,p.updateFollowingTopic=c,r()}t.module("waka").controller("topicController",["$scope","$state","Topic","User","iCookie",e])}(angular),function(t){"use strict";function e(e,o,n,i,r,s){function a(){r.get({_id:c()}).$promise.then(function(t){p.currentTopic=t.data,l(t.data._id),t.data.parent?u(t.data.parent):p.parentTopic={name:"无"}})}function u(t){r.get({_id:t}).$promise.then(function(t){p.parentTopic=t.data})}function l(t){r.sub({_id:t}).$promise.then(function(t){p.subTopicList=t.data})}function c(){return location.href.split("#/topic/")[1]}function d(e){i.show({template:'<topic-dialog parent-topic="tree.initTree()"></topic-dialog>',parent:t.element(document.body),targetEvent:e,clickOutsideToClose:!0}).then(function(t){})}var p=this;p.parentTopic="",p.currentTopic="",p.subTopicList="",p.showTopicDialog=d,a()}t.module("waka").controller("topicTreeController",["$scope","$state","$stateParams","$mdDialog","Topic","User",e])}(angular),function(t){"use strict";function e(t,e,o,n){function i(){o.get({id:n.getCookie("uid")}).$promise.then(function(t){console.log(t),r.user=t.data})}var r=this;r.user="",r.itemList=[{title:"我的提问",url:"question"},{title:"我的回答",url:"answer"},{title:"我的收藏",url:"collection"},{title:"关注话题",url:"topic"}],i(),r.userSetting=function(){e.go("user-setting")}}t.module("waka").controller("userPageController",["$scope","$state","User","iCookie",e])}(angular),function(t){"use strict";function e(t,e,o){}t.module("waka").controller("userAnswerController",["$scope","$state","User",e])}(angular),function(t){"use strict";function e(t,e,o){}t.module("waka").controller("userCollectionController",["$scope","$state","User",e])}(angular),function(t){"use strict";function e(t,e,o){}t.module("waka").controller("userQuestionController",["$scope","$state","User",e])}(angular),function(t){"use strict";function e(t,e,o){}t.module("waka").controller("userTopicController",["$scope","$state","User",e])}(angular),function(t){"use strict";function e(t,e,o,n,i){function r(){n.getCurrentUser().$promise.then(function(t){var e=t.data;u.username=e.username,u.bio=e.bio,u.description=e.description})}function s(t){t=a(t),document.cookie="password="+t+";max-age=864000"}function a(t){return CryptoJS.AES.encrypt(t,"iwaka")}var u=this;u.picFile="",u.username="",u.bio="",u.description="",u.oldPassword="",u.newPassword="",u.newPassword2="",u.savingAvatar=!1,u.savingInfo=!1,u.savingPassword=!1,r(),u.updateInfo=function(){var t={username:u.username,bio:u.bio,description:u.description};n.update(t).$promise.then(function(t){u.savingInfo=!0,t.status>-1&&o(function(){u.savingInfo=!1,u.savingInfoMes="保存成功"},2e3)})},u.updatePassword=function(){u.newPassword!==u.newPassword2&&(u.savingPasswordMes="密码不一致");var t={oldPassword:u.oldPassword,newPassword:u.newPassword};n.updatePassword(t).$promise.then(function(t){u.savingPassword=!0,console.log(t),t.data.error?(u.savingPassword=!1,u.savingPasswordMes="旧密码不正确"):o(function(){u.savingPassword=!1,u.savingPasswordMes="保存成功",s(u.newPassword)},2e3)})},u.upload=function(t){u.savingAvatar=!0,i.upload({url:"/api/user/imgUpload",file:i.dataUrltoBlob(t)}).then(function(t){t.status>-1&&o(function(){window.location.reload()},2500)})}}t.module("waka").controller("userSettingController",["$scope","$state","$timeout","User","Upload",e])}(angular),function(t){"use strict";function e(t,e,o,n){function i(t){n.login(t).$promise.then(function(n){if(console.log(n),-1===n.status)switch(n.error){case"user":case"password":return c.auth.loginErr=!0,void e(r,4e3)}n.status>-1&&(a("uid")||(console.log("set cookie"),s(n.data._id,n.data.username,t.password)),e(function(){o.go("home-page")},1e3))})}function r(){c.auth={email:!1,pass:!1,userExist:!1,loginErr:!1,emailExist:!1}}function s(t,e,o){e=u(e),o=u(o),document.cookie="uid="+t+";max-age=864000",document.cookie="username="+e+";max-age=864000",document.cookie="password="+o+";max-age=864000"}function a(t){var e=document.cookie;if(e){e=e.substr(e.indexOf(t));var o=e.indexOf(";")>-1?e.indexOf(";"):e.length,n=e.substring(e.indexOf("=")+1,o);return n}return null}function u(t){return CryptoJS.AES.encrypt(t,"iwaka")}function l(t){return CryptoJS.AES.decrypt(t,"iwaka").toString(CryptoJS.enc.Utf8)}var c=this,d=/^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;c.signin=!0,c.auth={email:!1,pass:!1,loginErr:!1,userExist:!1,emailExist:!1},function(){if(a("uid")){var t={username:l(a("username")),password:l(a("password"))};i(t)}}(),c.login=function(){var t={email:d.test(c.email)?c.email:"",username:d.test(c.email)?"":c.email,password:c.password};i(t)},c.signup=function(){var t=c.reg;if(t.password!==t.password2)return c.auth.pass=!0,void e(r,4e3);if(!d.test(t.email))return c.auth.email=!0,void e(r,4e3);var i={username:t.username,email:t.email,password:t.password};n.save(i).$promise.then(function(t){if(console.log(t),-1===t.status)switch(t.error){case"email":return c.auth.emailExist=!0,void e(r,4e3);case"username":return c.auth.userExist=!0,void e(r,4e3)}t.status>-1&&(console.log("signup success"),o.go("user-login"))},function(t){console.log("signup fail"),console.log(t)})}}t.module("waka").controller("loginController",["$scope","$timeout","$state","User",e])}(angular);